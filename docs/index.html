<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helios Tech Project Documentation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #3b82f6;
            --accent-color: #f43f5e;
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --card-bg: #ffffff;
            --hover-bg: #f1f5f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .documentation-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 5rem 0;
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
        }

        .documentation-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><rect width="1" height="1" fill="rgba(255,255,255,0.1)"/></svg>');
            opacity: 0.3;
        }

        .documentation-header h1 {
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .documentation-header .lead {
            font-size: 1.25rem;
            opacity: 0.9;
        }

        .section-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .section-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .section-card h3 {
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .code-icon {
            font-size: 1.75rem;
            color: var(--secondary-color);
            transition: all 0.3s ease;
        }

        .code-icon:hover {
            color: var(--accent-color);
            transform: scale(1.1) rotate(-5deg);
        }

        .api-endpoint {
            background: var(--card-bg);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            transition: all 0.3s ease;
        }

        .api-endpoint:hover {
            background: var(--hover-bg);
            transform: translateX(5px);
        }

        .method-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .get { 
            background-color: #60a5fa;
            color: #1e3a8a;
        }
        
        .post { 
            background-color: #34d399;
            color: #064e3b;
        }

        .put { 
            background-color: #fbbf24;
            color: #92400e;
        }

        .delete { 
            background-color: #f87171;
            color: #991b1b;
        }

        .preview-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .preview-link:hover {
            color: var(--accent-color);
        }

        .code-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-left: 0.75rem;
            font-size: 0.875rem;
            color: var(--accent-color);
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .code-link:hover {
            opacity: 1;
            transform: translateX(2px);
        }

        .endpoint-description {
            margin-top: 1rem;
            color: #64748b;
        }

        .endpoint-params {
            margin-top: 0.75rem;
            font-size: 0.875rem;
        }

        .param-name {
            color: var(--primary-color);
            font-family: monospace;
            background: var(--bg-color);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
        }

        .param-type {
            color: #64748b;
            font-style: italic;
        }

        .endpoint-response {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .code-preview {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1.5rem;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre;
            overflow-x: auto;
            tab-size: 4;
        }

        .code-preview::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .code-preview::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 4px;
        }

        .code-preview::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }

        .code-preview::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .code-preview pre {
            margin: 0;
        }

        .code-preview code {
            font-family: 'Fira Code', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <header class="documentation-header text-center">
        <div class="container">
            <h1 class="animate__animated animate__fadeInDown">Helios Tech Project Documentation</h1>
            <p class="lead animate__animated animate__fadeInUp">Comprehensive guide to BigQuery Structure and FastAPI Integration</p>
        </div>
    </header>

    <div class="container">
        <section id="bigquery" class="mb-5">
            <h2 class="section-title">BigQuery Structure</h2>
            
            <!-- Views -->
            <div class="section-card animate__animated animate__fadeInUp">
                <h3>
                    <i class="bi bi-table code-icon"></i>
                    Views
                </h3>
                <p>Custom views for data analysis and reporting.</p>
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <strong>
                            <a class="preview-link">
                                <i class="bi bi-eye-fill"></i>
                                vw_weight
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('vw_weight')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </strong>
                        <p class="mt-2">Calculates historical weights for temporal analysis, with decreasing weights for older years.</p>
                    </li>
                </ul>
            </div>

            <!-- Functions -->
            <div class="section-card animate__animated animate__fadeInUp">
                <h3>
                    <i class="bi bi-code-square code-icon"></i>
                    Functions
                </h3>
                <p>Custom functions for date and calculations.</p>
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <strong>
                            <a class="preview-link">
                                <i class="bi bi-eye-fill"></i>
                                fc_first_day_week_of_year
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('fc_first_day_week_of_year')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </strong>
                        <p class="mt-2">Calculates the first day of the week for a given year and week number.</p>
                        <strong>Parameters:</strong>
                        <ul>
                            <li><span class="param-name">YEAR</span> <span class="param-type">(INT64)</span> - Year</li>
                            <li><span class="param-name">WEEK_NUM</span> <span class="param-type">(INT64)</span> - Week number</li>
                        </ul>
                        <strong>Return:</strong> DATE - First day of the specified week
                    </li>

                    <li class="mb-3">
                        <strong>
                            <a class="preview-link">
                                <i class="bi bi-eye-fill"></i>
                                fc_end_day_week_of_year
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('fc_end_day_week_of_year')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </strong>
                        <p class="mt-2">Calculates the last day of the week for a given year and week number.</p>
                        <strong>Parameters:</strong>
                        <ul>
                            <li><span class="param-name">YEAR</span> <span class="param-type">(INT64)</span> - Year</li>
                            <li><span class="param-name">WEEK_NUM</span> <span class="param-type">(INT64)</span> - Week number</li>
                        </ul>
                        <strong>Return:</strong> DATE - Last day of the specified week
                    </li>
                </ul>
            </div>

            <!-- Procedures -->
            <div class="section-card animate__animated animate__fadeInUp">
                <h3>
                    <i class="bi bi-gear code-icon"></i>
                    Procedures
                </h3>
                <p>Stored procedures for business logic.</p>
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <strong>
                            <a class="preview-link">
                                <i class="bi bi-eye-fill"></i>
                                pr_1_calculate_growing
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('pr_1_calculate_growing')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </strong>
                        <p class="mt-2">Procedure that calculates growing seasons for a crop in a specific location.</p>
                        <strong>Parameters:</strong>
                        <ul>
                            <li><span class="param-name">pr_h3_index</span> <span class="param-type">(INT64)</span> - H3 location index</li>
                            <li><span class="param-name">pr_crop_id_or_name</span> <span class="param-type">(STRING)</span> - Crop ID or name</li>
                        </ul>
                    </li>

                    <li class="mb-3">
                        <strong>
                            <a class="preview-link">
                                <i class="bi bi-eye-fill"></i>
                                pr_2_daily_risk
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('pr_2_daily_risk')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </strong>
                        <p class="mt-2">Procedure that calculates daily risk for a crop in a specific location.</p>
                        <strong>Parameters:</strong>
                        <ul>
                            <li><span class="param-name">pr_h3_index</span> <span class="param-type">(INT64)</span> - H3 location index</li>
                            <li><span class="param-name">pr_crop_id_or_name</span> <span class="param-type">(STRING)</span> - Crop ID or name</li>
                        </ul>
                    </li>

                    <li class="mb-3">
                        <strong>
                            <a class="preview-link">
                                <i class="bi bi-eye-fill"></i>
                                pr_3_api_crop_risk
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('pr_3_api_crop_risk')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </strong>
                        <p class="mt-2">Procedure that evaluates risk for a crop based on current temperature.</p>
                        <strong>Parameters:</strong>
                        <ul>
                            <li><span class="param-name">pr_crop_id_or_name</span> <span class="param-type">(STRING)</span> - Crop ID or name</li>
                            <li><span class="param-name">actual_temp</span> <span class="param-type">(FLOAT64)</span> - Current temperature</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </section>

        <section id="fastapi" class="mb-5">
            <h2 class="section-title">FastAPI Documentation</h2>

            <div class="section-card animate__animated animate__fadeInUp">
                <h3>
                    <i class="bi bi-hdd-network code-icon"></i>
                    API Endpoints
                </h3>

                <!-- GET /crop-info/ -->
                <div class="api-endpoint">
                    <div class="d-flex align-items-center gap-3">
                        <span class="method-badge get">GET</span>
                        <code>
                            <a class="preview-link">
                                <i class="bi bi-eye-fill"></i>
                                /crop-info/
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('crop-info')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </code>
                    </div>
                    <div class="endpoint-description">
                        Get information about a specific crop by ID or name.
                    </div>
                    <div class="endpoint-params">
                        <strong>Parameters:</strong>
                        <ul>
                            <li><span class="param-name">crop_id</span> <span class="param-type">(string, optional)</span> - Unique crop ID</li>
                            <li><span class="param-name">name</span> <span class="param-type">(string, optional)</span> - Crop name</li>
                        </ul>
                    </div>
                    <div class="endpoint-response">
                        <strong>Response:</strong> List of CropInfo objects containing crop data
                    </div>
                </div>

                <!-- POST /crop-insert/ -->
                <div class="api-endpoint">
                    <div class="d-flex align-items-center gap-3">
                        <span class="method-badge post">POST</span>
                        <code>
                            <a class="preview-link">
                                <i class="bi bi-eye-fill"></i>
                                /crop-insert/
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('crop-insert')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </code>
                    </div>
                    <div class="endpoint-description">
                        Creates a new crop with its temperature characteristics.
                    </div>
                    <div class="endpoint-params">
                        <strong>Body:</strong>
                        <ul>
                            <li><span class="param-name">name</span> <span class="param-type">(string, required)</span> - Crop name</li>
                            <li><span class="param-name">temp_min</span> <span class="param-type">(float, required)</span> - Ideal minimum temperature</li>
                            <li><span class="param-name">temp_max</span> <span class="param-type">(float, required)</span> - Ideal maximum temperature</li>
                        </ul>
                    </div>
                    <div class="endpoint-response">
                        <strong>Response:</strong> Insertion confirmation with status
                    </div>
                </div>

                <!-- GET /crop-risk-temp/ -->
                <div class="api-endpoint">
                    <div class="d-flex align-items-center gap-3">
                        <span class="method-badge get">GET</span>
                        <code>
                            <a class="preview-link"
                                data-bs-toggle="popover"
                                data-bs-trigger="hover"
                                data-bs-html="true">
                                <i class="bi bi-eye-fill"></i>
                                /crop-risk-temp/
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('crop-risk-temp')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </code>
                    </div>
                    <div class="endpoint-description">
                        Evaluates crop risk based on current temperature.
                    </div>
                    <div class="endpoint-params">
                        <strong>Parameters:</strong>
                        <ul>
                            <li><span class="param-name">temperature</span> <span class="param-type">(float, required)</span> - Current temperature</li>
                            <li><span class="param-name">crop_id</span> <span class="param-type">(string, optional)</span> - Crop ID</li>
                            <li><span class="param-name">name</span> <span class="param-type">(string, optional)</span> - Crop name</li>
                        </ul>
                    </div>
                    <div class="endpoint-response">
                        <strong>Response:</strong> Crop information with risk status
                    </div>
                </div>

                <!-- GET /supplier/ -->
                <div class="api-endpoint">
                    <div class="d-flex align-items-center gap-3">
                        <span class="method-badge get">GET</span>
                        <code>
                            <a class="preview-link"
                                data-bs-toggle="popover"
                                data-bs-trigger="hover"
                                data-bs-html="true">
                                <i class="bi bi-eye-fill"></i>
                                /supplier/
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('supplier')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </code>
                    </div>
                    <div class="endpoint-description">
                        Get supplier information by ID or name.
                    </div>
                    <div class="endpoint-params">
                        <strong>Parameters:</strong>
                        <ul>
                            <li><span class="param-name">poi_id</span> <span class="param-type">(string, optional)</span> - Point of interest ID</li>
                            <li><span class="param-name">supplier_name</span> <span class="param-type">(string, optional)</span> - Supplier name</li>
                        </ul>
                    </div>
                    <div class="endpoint-response">
                        <strong>Response:</strong> List of SupplierInfo objects containing supplier data
                    </div>
                </div>

                <!-- GET /growing-info/ -->
                <div class="api-endpoint">
                    <div class="d-flex align-items-center gap-3">
                        <span class="method-badge get">GET</span>
                        <code>
                            <a class="preview-link"
                                data-bs-toggle="popover"
                                data-bs-trigger="hover"
                                data-bs-html="true">
                                <i class="bi bi-eye-fill"></i>
                                /growing-info/
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('growing-info')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </code>
                    </div>
                    <div class="endpoint-description">
                        Get growing season information by H3 index or crop ID.
                    </div>
                    <div class="endpoint-params">
                        <strong>Parameters:</strong>
                        <ul>
                            <li><span class="param-name">h3index_num</span> <span class="param-type">(integer, optional)</span> - H3 location index</li>
                            <li><span class="param-name">crop_id</span> <span class="param-type">(string, optional)</span> - Crop ID</li>
                        </ul>
                    </div>
                    <div class="endpoint-response">
                        <strong>Response:</strong> List of GrowingInfo objects containing growing season data
                    </div>
                </div>
            </div>

            <!-- Models -->
            <div class="section-card animate__animated animate__fadeInUp">
                <h3>
                    <i class="bi bi-diagram-3 code-icon"></i>
                    Data Models
                </h3>
                <p>Pydantic models for data validation.</p>
                <ul class="list-unstyled">
                    <!-- Crop Models -->
                    <li class="mb-3">
                        <strong>
                            <a class="preview-link"
                                data-bs-toggle="popover"
                                data-bs-trigger="hover"
                                data-bs-html="true">
                                <i class="bi bi-eye-fill"></i>
                                Crop Models
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('crop-models')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </strong>
                        <div class="mt-2">
                            <p>Data models for validation and serialization:</p>
                            <ul>
                                <li><strong>Crop</strong>: Base model with common fields</li>
                                <li><strong>CropInfo</strong>: Model for returning complete information</li>
                                <li><strong>CropCreate</strong>: Model for creating new crops</li>
                                <li><strong>CropUpdate</strong>: Model for updating existing crops</li>
                            </ul>
                        </div>
                    </li>

                    <!-- Supplier Models -->
                    <li class="mb-3">
                        <strong>
                            <a class="preview-link"
                                data-bs-toggle="popover"
                                data-bs-trigger="hover"
                                data-bs-html="true">
                                <i class="bi bi-eye-fill"></i>
                                Supplier Models
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('supplier-models')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </strong>
                        <div class="mt-2">
                            <p>Models for suppliers:</p>
                            <ul>
                                <li><strong>Supplier</strong>: Base model with supplier information</li>
                                <li><strong>SupplierInfo</strong>: Complete model with point of interest ID</li>
                            </ul>
                        </div>
                    </li>

                    <!-- Growing Models -->
                    <li class="mb-3">
                        <strong>
                            <a class="preview-link"
                                data-bs-toggle="popover"
                                data-bs-trigger="hover"
                                data-bs-html="true">
                                <i class="bi bi-eye-fill"></i>
                                Growing Models
                            </a>
                            <a href="javascript:void(0)" 
                               onclick="viewCode('growing-models')"
                               class="code-link">
                                <i class="bi bi-code-square"></i>
                                View Full Code
                            </a>
                        </strong>
                        <div class="mt-2">
                            <p>Models for growing seasons:</p>
                            <ul>
                                <li><strong>Growing</strong>: Base model with season information</li>
                                <li><strong>GrowingInfo</strong>: Model for returning complete information</li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
        </section>
    </div>

    <!-- Code Modal -->
    <div class="modal fade" id="codeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre><code class="language-sql"></code></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const codeSnippets = {
            "vw_weight": {
                title: "View: vw_weight",
                language: "sql",
                code: `CREATE OR REPLACE VIEW \`helios-tech-interview-project.result_test.vw_weight\`
AS
SELECT CAST(.15 AS FLOAT64) AS pr_weight, EXTRACT(YEAR FROM CURRENT_DATE())-1  AS pr_year UNION ALL
SELECT CAST(.15 AS FLOAT64) AS pr_weight, EXTRACT(YEAR FROM CURRENT_DATE())-2  AS pr_year UNION ALL
SELECT CAST(.15 AS FLOAT64) AS pr_weight, EXTRACT(YEAR FROM CURRENT_DATE())-3  AS pr_year UNION ALL
SELECT CAST(.15 AS FLOAT64) AS pr_weight, EXTRACT(YEAR FROM CURRENT_DATE())-4  AS pr_year UNION ALL
SELECT CAST(.15 AS FLOAT64) AS pr_weight, EXTRACT(YEAR FROM CURRENT_DATE())-5  AS pr_year UNION ALL
SELECT CAST(.10 AS FLOAT64) AS pr_weight, EXTRACT(YEAR FROM CURRENT_DATE())-6  AS pr_year UNION ALL
SELECT CAST(.08 AS FLOAT64) AS pr_weight, EXTRACT(YEAR FROM CURRENT_DATE())-7  AS pr_year UNION ALL
SELECT CAST(.04 AS FLOAT64) AS pr_weight, EXTRACT(YEAR FROM CURRENT_DATE())-8  AS pr_year UNION ALL
SELECT CAST(.02 AS FLOAT64) AS pr_weight, EXTRACT(YEAR FROM CURRENT_DATE())-9  AS pr_year UNION ALL
SELECT CAST(.01 AS FLOAT64) AS pr_weight, EXTRACT(YEAR FROM CURRENT_DATE())-10 AS pr_year`
            },
            "fc_first_day_week_of_year": {
                title: "Function: First Day of Week",
                language: "sql",
                code: `CREATE OR REPLACE FUNCTION \`helios-tech-interview-project.result_test.fc_first_day_week_of_year\`(YEAR INT64, WEEK_NUM INT64) RETURNS DATE AS (
(    
    WITH 
    -- Capturing the 7 days prior to the 1st day of the year
    CTE_DATES AS (
      SELECT
        DATE_ADD(DATE(YEAR, 1, 1), INTERVAL -x DAY) AS date_in_range
      FROM UNNEST(GENERATE_ARRAY(0, 7)) AS x -- Generates an array with 8 elements, representing the days from 0 to 7
      ORDER BY 1
    )
    ,CTE_WEEK_NUMBER AS (
      SELECT 
        * 
        ,EXTRACT(ISOWEEK FROM date_in_range) AS week_number -- Extracts the ISO week number from the date_in_range
      FROM CTE_DATES
    )
    ,CTE_FIRST_DAY AS (
      SELECT 
        MIN(date_in_range) AS first_day_of_week -- Finds the first day of the week
      FROM CTE_WEEK_NUMBER 
      WHERE week_number = 1 -- Filters to find the first week of the year
    )

    -- Adds the specified number of weeks (WEEK_NUM) to the first day of the first week
    SELECT 
      DATE_ADD(
        (SELECT first_day_of_week FROM CTE_FIRST_DAY), -- Gets the first day of the first week
        INTERVAL (WEEK_NUM - 1) WEEK -- Adds the number of weeks specified by WEEK_NUM
      ) AS first_day_of_week -- Returns the first day of the desired week

  )
);`
            },
            "fc_end_day_week_of_year": {
                title: "Function: Last Day of Week",
                language: "sql",
                code: `CREATE OR REPLACE FUNCTION \`helios-tech-interview-project.result_test.fc_end_day_week_of_year\`(YEAR INT64, WEEK_NUM INT64) RETURNS DATE AS (
(    
    SELECT DATE(\`helios-tech-interview-project.result_test.fc_first_day_week_of_year\`(YEAR, WEEK_NUM) + INTERVAL 6 DAY)
  )
);`
            },
            "pr_1_calculate_growing": {
                title: "Procedure: Calculate Growing Seasons",
                language: "sql",
                code: `CREATE OR REPLACE PROCEDURE \`helios-tech-interview-project.result_test.pr_1_calculate_growing\`(pr_h3_index INT64, pr_crop_id_or_name STRING)
BEGIN
  DECLARE table_exists BOOL;

  /** 
   * #### h3_index_param
   * This procedure needs to be run for each h3index_num (tied to a specific location) 
   * as each location has different climatic conditions affecting the growing season.
   **/

  /** 
   * #### pr_crop_id_or_name
   * Accepts either crop_id or crop name as a string to filter the crop information.
   **/
  
  CREATE TEMP TABLE TBL_TEMP AS
  
  WITH 
  CTE_CROP_TEMP AS (
    -- Fetch crop temperature range (min and max) based on provided crop_id or name
    SELECT DISTINCT
      1 AS id, crop_id, temp_min, temp_max 
    FROM \`shared.crop_info\`
    WHERE crop_id = pr_crop_id_or_name
    OR name = pr_crop_id_or_name
  )
  
  ,CTE_WEEKLY_AVG AS (
      -- Calculate weekly average min and max temperature for the given h3index_num and year range
      SELECT  
        wi.h3index_num,
        wi.date_on_year, 
        wi.date_on_week,
        AVG(wi.tempmin) AS tempmin_wk_avg,
        AVG(wi.tempmax) AS tempmax_wk_avg
      FROM \`weather_data.historical_weather_raw_import\` wi
      WHERE date_on_year >= (SELECT MIN(pr_year) FROM \`result_test.vw_weight\`)  -- Include data starting from the earliest year available for weight
      AND wi.h3index_num = pr_h3_index
      GROUP BY 1, 2, 3
  )
  
  ,CTE_WEIGHTED_WEEKLY_AVG AS (
    -- Compute weighted average temperature using the crop weight for each week
    SELECT 
      wk.h3index_num,
      wk.date_on_week,
      SUM(wk.tempmin_wk_avg * wg.pr_weight) AS weighted_mintemp_ten_yr_avg,
      SUM(wk.tempmax_wk_avg * wg.pr_weight) AS weighted_maxtemp_ten_yr_avg
    FROM CTE_WEEKLY_AVG wk
    LEFT JOIN \`result_test.vw_weight\` wg ON wg.pr_year = wk.date_on_year  
    GROUP BY 1, 2
  )
  
  ,CTE_IN_SEASON AS (
    -- Identify if the crop is in-season based on min/max temperatures
    SELECT 
      wa.h3index_num,
      cr.crop_id,
      wa.date_on_week,
      wa.weighted_mintemp_ten_yr_avg,
      wa.weighted_maxtemp_ten_yr_avg,
      CASE
        WHEN wa.weighted_mintemp_ten_yr_avg > cr.temp_min AND wa.weighted_maxtemp_ten_yr_avg < cr.temp_max 
        THEN 1  -- Crop is in-season
        ELSE 0   -- Crop is not in-season
      END AS in_season        
    FROM CTE_WEIGHTED_WEEKLY_AVG wa
    LEFT JOIN CTE_CROP_TEMP cr ON cr.id = 1  
  )

  ,CTE_PREV_IN_SEASON AS (
    -- Compare the current in_season with the previous week using LAG function
    SELECT 
        * EXCEPT(weighted_mintemp_ten_yr_avg, weighted_maxtemp_ten_yr_avg)
        ,LAG(in_season) OVER (PARTITION BY h3index_num, crop_id ORDER BY date_on_week) AS previous_in_season
    FROM CTE_IN_SEASON
  )
  
  ,CTE_RANK AS (
    -- Generate a rank sequence whenever there is a change in in_season (crop starts or ends season)
    SELECT 
        *    
        ,SUM(CASE WHEN in_season != previous_in_season THEN 1 ELSE 0 END) 
        OVER (PARTITION BY h3index_num, crop_id ORDER BY date_on_week) + 1 AS rank_group
    FROM CTE_PREV_IN_SEASON  
    ORDER BY 1, 2, 3
  )
  
  ,CTE_SEASON_WEEK AS (
    -- Calculate the start and end weeks of the growing season for each rank_group
    SELECT
      * EXCEPT(date_on_week, in_season, previous_in_season, rank_group)
      ,MIN(date_on_week) AS season_start_week
      ,MAX(date_on_week) AS season_end_week
    FROM CTE_RANK
    WHERE in_season = 1  -- Only consider rows where the crop is in-season
    GROUP BY h3index_num, crop_id, rank_group
  )
  
  ,CTE_SEASON_DATE AS (
    -- Calculate the exact start and end date of the season based on the week range
    SELECT
      *
      ,\`result_test.fc_first_day_week_of_year\`(EXTRACT(YEAR FROM CURRENT_DATE()), season_start_week) AS season_start_date
      ,\`result_test.fc_end_day_week_of_year\`(EXTRACT(YEAR FROM CURRENT_DATE()), season_end_week) AS season_end_date
      ,season_end_week - season_start_week AS length_of_season_weeks      
    FROM CTE_SEASON_WEEK
  )
  
  ,CTE_RESULT AS (
    -- Calculate the number of days the growing season lasts
    SELECT
      *
      ,DATE_DIFF(season_end_date, season_start_date, DAY) AS length_of_season_days
    FROM CTE_SEASON_DATE
  )

  -- Final result selection
  SELECT * FROM CTE_RESULT;

  -- Check if the destination table already exists
  SET table_exists = (
    SELECT COUNT(*) > 0
    FROM \`result_test\`.INFORMATION_SCHEMA.TABLES
    WHERE table_name = 'tb_1_growing_seasons'
  );

  IF NOT table_exists THEN
    -- Create the final table from the temporary table if it does not exist
    CREATE TABLE \`result_test.tb_1_growing_seasons\` AS
    SELECT * FROM TBL_TEMP;
  ELSE
    -- Delete existing records to avoid duplicates before inserting new data
    DELETE FROM \`result_test.tb_1_growing_seasons\`
    WHERE EXISTS (
        SELECT 1
        FROM TBL_TEMP tm
        WHERE tm.h3index_num = \`result_test.tb_1_growing_seasons\`.h3index_num
          AND tm.crop_id = \`result_test.tb_1_growing_seasons\`.crop_id
    );

    -- Insert the new data into the table
    INSERT INTO \`result_test.tb_1_growing_seasons\`
    SELECT * FROM TBL_TEMP;
  END IF;

END;`
            },
            "pr_2_daily_risk": {
                title: "Procedure: Calculate Daily Risk",
                language: "sql",
                code: `CREATE OR REPLACE PROCEDURE \`helios-tech-interview-project.result_test.pr_2_daily_risk\`(pr_h3_index INT64, pr_crop_id_or_name STRING)
BEGIN
  /** 
   * #### h3_index_param
   * This procedure must be run for each h3index_num (linked to a specific lat/long) 
   * as each location has slightly different climatic conditions.
   **/
   
  /** 
   * #### pr_crop_id_or_name
   * Accepts either crop_id or crop name as a string to filter the crop information.
   **/
  
  CREATE OR REPLACE TABLE \`helios-tech-interview-project.result_test.tb_2_daily_risk\`
  AS
  WITH 
  CTE_Crop AS (
    -- Get crop info (id, name, temperature range) for the specified crop_id or name
    SELECT DISTINCT
        crop_id, name, temp_min, temp_max 
    FROM \`helios-tech-interview-project.shared.crop_info\`
    WHERE crop_id = pr_crop_id_or_name
    OR name = pr_crop_id_or_name
  )
  
  ,CTE_Supplier AS (
    -- Fetch suppliers for the given h3index_num and crop, joining with the crop info
    SELECT 
       sp.poi_id
      ,sp.supplier_name
      ,sp.h3index_num
      ,sp.crop_id
      ,cr.name as crop_name
      ,cr.temp_min
      ,cr.temp_max 
    FROM \`helios-tech-interview-project.shared.places_of_interest\` sp
    INNER JOIN CTE_Crop cr on cr.crop_id = sp.crop_id
    WHERE sp.h3index_num = pr_h3_index
  )
  
  ,CTE_Result AS (
    -- Calculate risk status by checking if the daily temperature is within the crop's min/max temperature range
    SELECT 
    sp.* 
    ,hs.date_on
    ,hs.temp
    ,CASE 
        WHEN hs.temp > sp.temp_min AND hs.temp < sp.temp_max
        THEN 0 -- Within the safe temperature range
        ELSE 1 -- Outside the safe temperature range
      END AS risk_status
    FROM CTE_Supplier sp
    INNER JOIN \`helios-tech-interview-project.weather_data.historical_weather_raw_import\` hs on hs.h3index_num = sp.h3index_num  
  )

  -- Final result selection, excluding some unnecessary columns for the final table
  SELECT 
    * EXCEPT(crop_name, temp_min, temp_max, temp) 
  FROM CTE_Result
  ;
END;`
            },
            "pr_3_api_crop_risk": {
                title: "Procedure: API Crop Risk",
                language: "sql",
                code: `CREATE OR REPLACE PROCEDURE \`helios-tech-interview-project.result_test.pr_3_api_crop_risk\`(pr_crop_id_or_name STRING, actual_temp FLOAT64)
BEGIN
  #### pr_crop_id_or_name: This parameter accepts only string values​ ​and can receive either the crop_id or the name of the crop.
  #### actual_temp:  Current temperature
    
  SELECT DISTINCT
      crop_id, name, temp_min, temp_max, actual_temp as temperature
      ,CASE 
        WHEN actual_temp > temp_min AND actual_temp < temp_max
        THEN 1 --Inside the Range
        ELSE 0 --Out of Range
      END AS risk_status
      ,CASE 
        WHEN actual_temp > temp_min AND actual_temp < temp_max
        THEN 'in season' --Inside the Range
        ELSE 'out of season' --Out of Range
      END AS risk_desc
  FROM \`helios-tech-interview-project.shared.crop_info\`
  WHERE crop_id = pr_crop_id_or_name
  OR name = pr_crop_id_or_name;  
END;`
            },
            "crop-info": {
                title: "Endpoint: GET /crop-info/",
                language: "python",
                code: `@router.get("/crop-info/", response_model=List[model.CropInfo])
async def get_crop_info(crop_id: Optional[str] = None, name: Optional[str] = None):
    """    
    Get crop information by passing crop id or name. 
    - At least one parameter must be provided.
    """
    if not crop_id and not name:
        raise HTTPException(
            status_code=400,
            detail="Either crop_id or name must be provided"
        )

    query = "SELECT * FROM \`helios-tech-interview-project.shared.crop_info\`"
    
    if crop_id:
        query += f" WHERE crop_id = '{crop_id}'"        
    if name:
        query += f" WHERE name = '{name}'"        

    return bq.exec_query_bq(query)`
            },
            "crop-insert": {
                title: "Endpoint: POST /crop-insert/",
                language: "python",
                code: `@router.post("/crop-insert/", response_model=dict)
async def create_crop(crop: model.CropCreate):
    """
    Create a new crop
    """
    # Check if crop_id already exists
    query = f"""SELECT COUNT(*) as count 
               FROM \`helios-tech-interview-project.shared.crop_info\` 
               WHERE name = '{crop.name}'"""
    
    result = bq.exec_query_bq(query)
    if result[0]["count"] > 0:
        raise HTTPException(
            status_code=400,
            detail=f"Crop with name {crop.name} already exists"
        )
    
    query = f"""INSERT INTO \`helios-tech-interview-project.shared.crop_info\` 
                      (crop_id, name, temp_min, temp_max) 
                      VALUES (
                           GENERATE_UUID()
                          ,'{crop.name}'
                          ,{crop.temp_min}
                          ,{crop.temp_max}
                      )"""

    return bq.exec_dml_query_bq(query)`
            },
            "crop-risk-temp": {
                title: "Endpoint: GET /crop-risk-temp/",
                language: "python",
                code: `@router.get("/crop-risk-temp/", response_model=List[model.CropRisk])
async def get_crop_risk(temperature: float, crop_id: Optional[str] = None, name: Optional[str] = None):
    """    
    Get information about the crop risk by entering the temperature and either crop_id or name.
    
    Parameters:
    - temperature: Current temperature to check risk
    - crop_id: Optional crop ID
    - name: Optional crop name
    At least crop_id or name must be provided.
    """
    if not crop_id and not name:
        raise HTTPException(
            status_code=400,
            detail="Either crop_id or name must be provided"
        )

    search_value = crop_id if crop_id else name
    query = f"CALL \`helios-tech-interview-project.result_test.pr_3_api_crop_risk\`('{search_value}', {temperature});"
    
    return bq.exec_query_bq(query)`
            },
            "supplier": {
                title: "Endpoint: GET /supplier/",
                language: "python",
                code: `@router.get("/supplier/", response_model=List[SupplierInfo])
async def get_supplier_info(poi_id: Optional[str] = None, supplier_name: Optional[str] = None):
    """    
    Get supplier information by passing supplier id or supplier name. 
    At least one parameter must be provided.
    """
    if not poi_id and not supplier_name:
        raise HTTPException(
            status_code=400,
            detail="Either poi_id or supplier_name must be provided"
        )

    query = "SELECT * FROM \`helios-tech-interview-project.shared.places_of_interest\`"      
    
    if poi_id:
        query += f" WHERE poi_id = '{poi_id}'"
    if supplier_name:
        query += f" WHERE supplier_name = '{supplier_name}'"

    return bq.exec_query_bq(query)`
            },
            "growing-info": {
                title: "Endpoint: GET /growing-info/",
                language: "python",
                code: `@router.get("/growing-info/", response_model=List[model.GrowingInfo])
async def get_growing_info(h3index_num: Optional[int] = None, crop_id: Optional[str] = None):
    """    
    Get growing seasons information by passing h3index_num or crop_id. 
    - At least one parameter must be provided.
    """
    if not h3index_num and not crop_id:
        raise HTTPException(
            status_code=400,
            detail="Either h3index_num or crop_id must be provided"
        )

    query = "SELECT * FROM \`helios-tech-interview-project.result_test.tb_1_growing_seasons\` WHERE 1=1"

    if h3index_num:
        query += f" AND h3index_num = {h3index_num}"        
    if crop_id:
        query += f" AND crop_id = '{crop_id}'"        

    return bq.exec_query_bq(query)`
            },
            "crop-models": {
                title: "Models: Crop Models",
                language: "python",
                code: `class Crop(BaseModel):
    name: str
    temp_min: float
    temp_max: float

class CropInfo(Crop):
    crop_id: str    
    pass

class CropCreate(Crop):
    pass

class CropRisk(Crop):
    temperature: float
    risk_status: int
    risk_desc: str
    pass`
            },
            "supplier-models": {
                title: "Models: Supplier Models",
                language: "python",
                code: `class Supplier(BaseModel):
    supplier_name: str  
    country_code: str
    country_name: str
    h3index_num: int
    crop_id: str 

class SupplierInfo(Supplier):
    poi_id: str
    pass`
            },
            "growing-models": {
                title: "Models: Growing Models",
                language: "python",
                code: `class Growing(BaseModel):
    h3index_num: int
    crop_id: str
    season_start_week: int
    season_end_week: int
    season_start_date: date
    season_end_date: date
    length_of_season_weeks: int
    length_of_season_days: int

class GrowingInfo(Growing):
    pass`
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize highlight.js
            hljs.highlightAll();
        });

        function viewCode(id) {
            const snippet = codeSnippets[id];
            if (!snippet) {
                console.error('Code snippet not found:', id);
                return;
            }

            const modal = document.getElementById('codeModal');
            const modalTitle = modal.querySelector('.modal-title');
            const modalBody = modal.querySelector('.modal-body pre code');
            
            modalTitle.textContent = snippet.title;
            modalBody.textContent = snippet.code;
            modalBody.className = `language-${snippet.language}`;
            
            hljs.highlightElement(modalBody);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
    </script>
</body>
</html> 